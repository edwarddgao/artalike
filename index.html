<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Gallery with Similarity Search</title>
    <link rel="icon" href="data:,">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-button {
            padding: 8px 16px;
            background: #0070f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }

        .grid-row {
            display: flex;
            margin-bottom: 8px;
        }

        .image-item {
            position: relative;
            margin-right: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .image-item:last-child {
            margin-right: 0;
        }

        .image-item img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s ease;
        }

        .image-item:hover img {
            transform: scale(1.05);
        }

        #loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal img {
            max-width: 90%;
            max-height: 90vh;
            border-radius: 4px;
        }

        .error-message {
            text-align: center;
            padding: 20px;
            color: #e00;
            background: #fee;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="galleryTitle">Image Gallery</h1>
            <button id="backButton" class="back-button">Back to Main Gallery</button>
        </div>
        <div id="error" class="error-message"></div>
        <div id="grid"></div>
        <div id="loading">Loading...</div>
    </div>
    <div id="modal" class="modal">
        <img id="modalImage" src="" alt="Large preview">
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        const grid = document.getElementById('grid');
        const loading = document.getElementById('loading');
        const modal = document.getElementById('modal');
        const modalImage = document.getElementById('modalImage');
        const backButton = document.getElementById('backButton');
        const galleryTitle = document.getElementById('galleryTitle');
        const errorElement = document.getElementById('error');
        const targetRowHeight = 250;
        const spacing = 8;
        let images = [];
        let isLoading = false;
        let currentMode = 'random';
        let selectedImageUrl = null;

        function showError(message) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        async function fetchImages(mode = 'random', imageUrl = null) {
            try {
                const endpoint = mode === 'random' ? '/random' : '/search';
                const url = new URL(endpoint, API_BASE_URL);
                
                if (mode === 'random') {
                    url.searchParams.set('k', '20');
                } else {
                    url.searchParams.set('url', imageUrl);
                    url.searchParams.set('k', '20');
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.results;
            } catch (error) {
                console.error('Fetch error:', error);
                showError(`Failed to load images: ${error.message}`);
                return [];
            }
        }

        async function loadImageDimensions(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                
                img.onload = () => {
                    resolve({
                        url,
                        width: img.width || img.naturalWidth,
                        height: img.height || img.naturalHeight
                    });
                };
                
                img.onerror = () => {
                    console.warn(`Failed to load image: ${url}`);
                    reject(new Error(`Failed to load image: ${url}`));
                };
                
                img.src = url;
            });
        }

        function layoutGrid() {
            if (images.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px;">No images to display</div>';
                return;
            }

            const containerWidth = grid.offsetWidth;
            const rows = [];
            let currentRow = [];
            let currentRowWidth = 0;

            images.forEach((image, i) => {
                const ratio = image.width / image.height;
                const scaledWidth = targetRowHeight * ratio;

                if (currentRowWidth + scaledWidth <= containerWidth || currentRow.length === 0) {
                    currentRow.push({ ...image, scaledWidth });
                    currentRowWidth += scaledWidth + spacing;
                } else {
                    rows.push([...currentRow]);
                    currentRow = [{ ...image, scaledWidth }];
                    currentRowWidth = scaledWidth + spacing;
                }

                if (i === images.length - 1 && currentRow.length > 0) {
                    rows.push(currentRow);
                }
            });

            grid.innerHTML = '';
            rows.forEach((row, rowIndex) => {
                const rowEl = document.createElement('div');
                rowEl.className = 'grid-row';
                
                const rowWidth = row.reduce((sum, img) => sum + img.scaledWidth, 0) + 
                               (spacing * (row.length - 1));
                const scale = rowIndex === rows.length - 1 ? 1 : containerWidth / rowWidth;

                row.forEach(image => {
                    const width = Math.floor(image.scaledWidth * scale);
                    const height = Math.floor(targetRowHeight * scale);

                    const item = document.createElement('div');
                    item.className = 'image-item';
                    item.style.width = `${width}px`;
                    item.style.height = `${height}px`;

                    const img = document.createElement('img');
                    img.src = image.url;
                    img.loading = 'lazy';
                    img.addEventListener('click', () => handleImageClick(image.url));

                    item.appendChild(img);
                    rowEl.appendChild(item);
                });

                grid.appendChild(rowEl);
            });
        }

        async function handleImageClick(imageUrl) {
            if (currentMode === 'random') {
                currentMode = 'similar';
                selectedImageUrl = imageUrl;
                backButton.style.display = 'block';
                galleryTitle.textContent = 'Similar Images';
                await loadMore(true);
            } else {
                modalImage.src = imageUrl;
                modal.style.display = 'flex';
            }
        }

        async function loadMore(reset = false) {
            if (isLoading) return;
            
            isLoading = true;
            loading.style.display = 'block';
            errorElement.style.display = 'none';

            try {
                const urls = await fetchImages(currentMode, selectedImageUrl);
                const loadedImages = await Promise.all(
                    urls.map(url => loadImageDimensions(url).catch(error => {
                        console.warn(error);
                        return null;
                    }))
                );
                
                const validImages = loadedImages.filter(img => img !== null);
                images = reset ? validImages : [...images, ...validImages];
                layoutGrid();
            } catch (error) {
                console.error('Error loading images:', error);
                showError('Failed to load images. Please try again later.');
            } finally {
                loading.style.display = 'none';
                isLoading = false;
            }
        }

        window.addEventListener('scroll', () => {
            const buffer = 1000;
            if (window.innerHeight + window.scrollY + buffer >= document.documentElement.offsetHeight) {
                loadMore();
            }
        });

        window.addEventListener('resize', () => layoutGrid());

        backButton.addEventListener('click', async () => {
            currentMode = 'random';
            selectedImageUrl = null;
            backButton.style.display = 'none';
            galleryTitle.textContent = 'Image Gallery';
            await loadMore(true);
        });

        modal.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        loadMore(true);
    </script>
</body>
</html>